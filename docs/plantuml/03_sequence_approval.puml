@startuml Sequence_Approval
' ============================================================================
' SEQUENCE DIAGRAM - APPROVAL TINDAK LANJUT
' Version: 2.1 - Fixed: DITOLAK is FINAL status, no resubmit
' ============================================================================

skinparam backgroundColor #FEFEFE
skinparam shadowing false
skinparam defaultFontName "Segoe UI"
skinparam defaultFontSize 10

skinparam sequence {
    ArrowColor #455A64
    ArrowFontColor #37474F
    LifeLineBorderColor #78909C
    LifeLineBackgroundColor #ECEFF1
    ParticipantBorderColor #37474F
    ParticipantBackgroundColor #FFFFFF
    ActorBorderColor #1976D2
    ActorBackgroundColor #E3F2FD
    BoxBorderColor #9E9E9E
    BoxBackgroundColor #FAFAFA
}

autonumber

title **SD-03: Proses Approval Tindak Lanjut**

actor "Approver\n(Kepsek/Waka)" as APPROVER
actor "Pembina\n(WaliKelas/Kaprodi)" as PEMBINA

box "Application Layer" #E8F5E9
    participant "TindakLanjutController" as TLC
    participant "TindakLanjutService" as TLS
    participant "NotificationService" as NS
end box

box "Data Layer" #FFF3E0
    participant "TindakLanjut" as TL
    database "MySQL" as DB
end box

== Auto-Submit (Rules Engine Generated) ==

note over TL, DB
  Kasus auto-generated oleh Rules Engine
  dengan status = BARU (langsung ke approval)
end note

TL -> NS : Kirim notifikasi ke Approvers
NS --> APPROVER : Email/Push Notification

== Review by Approver ==

APPROVER -> TLC : GET /tindaklanjut/{id}
TLC -> TL : find(id)->with(['siswa', 'suratPanggilan'])
TL -> DB : SELECT with relations
DB --> TL : Complete data
TL --> TLC : TindakLanjut with relations
TLC --> APPROVER : Show detail page

== Approval Decision ==

alt Approve
    APPROVER -> TLC : POST /tindaklanjut/{id}/approve
    activate TLC
    
    TLC -> TLS : approve(id, userId)
    activate TLS
    
    TLS -> TL : update([status, penyetuju_user_id])
    TL -> DB : UPDATE tindak_lanjut\nSET status = 'Disetujui',\npenyetuju_user_id = ?
    DB --> TL : Updated
    TL --> TLS : Success
    
    TLS -> NS : notifyPembina(tindakLanjut, 'approved')
    NS --> PEMBINA : "Kasus disetujui"
    
    TLS --> TLC : Success
    deactivate TLS
    
    TLC --> APPROVER : Flash "Berhasil disetujui"
    deactivate TLC
    
    note right of PEMBINA
        Pembina dapat mulai
        menangani kasus
    end note

else Reject (FINAL)
    APPROVER -> TLC : POST /tindaklanjut/{id}/reject\n(alasan_tolak)
    activate TLC
    
    TLC -> TLS : reject(id, userId, alasan)
    activate TLS
    
    TLS -> TL : update([status, alasan_tolak])
    TL -> DB : UPDATE tindak_lanjut\nSET status = 'Ditolak',\nalasan_tolak = ?
    DB --> TL : Updated
    TL --> TLS : Success
    
    TLS -> NS : notifyPembina(tindakLanjut, 'rejected', alasan)
    NS --> PEMBINA : "Kasus ditolak: {alasan}"
    
    TLS --> TLC : Success
    deactivate TLS
    
    TLC --> APPROVER : Flash "Kasus ditolak"
    deactivate TLC
    
    note right of PEMBINA #FFEBEE
        **STATUS FINAL**
        Kasus tidak dapat
        di-revisi atau
        di-submit ulang
    end note
end

@enduml
