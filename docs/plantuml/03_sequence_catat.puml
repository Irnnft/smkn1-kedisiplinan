@startuml Sequence_Catat_Pelanggaran
' ============================================================================
' SEQUENCE DIAGRAM - CATAT PELANGGARAN
' ============================================================================

skinparam backgroundColor #FEFEFE
skinparam shadowing false
skinparam defaultFontName "Segoe UI"
skinparam defaultFontSize 10

skinparam sequence {
    ArrowColor #455A64
    ArrowFontColor #37474F
    LifeLineBorderColor #78909C
    LifeLineBackgroundColor #ECEFF1
    ParticipantBorderColor #37474F
    ParticipantBackgroundColor #FFFFFF
    ActorBorderColor #1976D2
    ActorBackgroundColor #E3F2FD
    BoxBorderColor #9E9E9E
    BoxBackgroundColor #FAFAFA
}

autonumber

title **SD-02: Proses Catat Pelanggaran**

actor "Guru" as GURU

box "Application Layer" #E8F5E9
    participant "RiwayatController" as RC
    participant "PelanggaranService" as PS
    participant "RulesEngine" as RE
    participant "TindakLanjutService" as TLS
    participant "SuratService" as SPS
end box

box "Data Layer" #FFF3E0
    participant "RiwayatPelanggaran" as RP
    participant "FrequencyRule" as FR
    participant "TindakLanjut" as TL
    participant "SuratPanggilan" as SP
    database "MySQL" as DB
end box

GURU -> RC : POST /pelanggaran/store\n(siswa_id, jenis_id, keterangan)
activate RC

RC -> PS : createPelanggaran(data)
activate PS

PS -> RP : create(data)
RP -> DB : INSERT INTO riwayat_pelanggaran
DB --> RP : riwayat created
RP --> PS : RiwayatPelanggaran object

PS -> RE : processViolation(siswa, jenisPelanggaran)
activate RE

RE -> DB : COUNT previous violations\nfor this siswa & jenis
DB --> RE : count = N

RE -> FR : getMatchingRule(jenis_id, N)
FR -> DB : SELECT * FROM frequency_rules\nWHERE frequency_min <= N\nAND frequency_max >= N
DB --> FR : matched rule
FR --> RE : FrequencyRule object

alt Rule Found & trigger_surat = true
    RE -> TLS : createTindakLanjut(siswa, rule)
    activate TLS
    
    TLS -> TL : create(data)
    TL -> DB : INSERT INTO tindak_lanjut
    DB --> TL : tindakLanjut created
    TL --> TLS : TindakLanjut object
    
    TLS -> SPS : createSuratPanggilan(tindakLanjut, rule)
    activate SPS
    
    SPS -> SP : create(data)
    SP -> DB : INSERT INTO surat_panggilan
    DB --> SP : surat created
    SP --> SPS : SuratPanggilan object
    
    SPS --> TLS : Return surat
    deactivate SPS
    
    TLS --> RE : Return tindakLanjut + surat
    deactivate TLS
    
    note right of RE
        Kirim notifikasi ke
        pembina berdasarkan
        pembina_roles di rule
    end note
end

RE -> DB : Check total poin vs\nPembinaanInternalRules
DB --> RE : matched pembinaan rule

alt Pembinaan Rule Matched
    RE -> DB : INSERT INTO pembinaan_status
    DB --> RE : pembinaan created
end

RE --> PS : Return processing result
deactivate RE

PS --> RC : Return success
deactivate PS

RC --> GURU : Redirect with flash message\n"Pelanggaran berhasil dicatat"
deactivate RC

@enduml
