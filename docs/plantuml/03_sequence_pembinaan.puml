@startuml Sequence_Pembinaan
' ============================================================================
' SEQUENCE DIAGRAM - PROSES PEMBINAAN INTERNAL
' ============================================================================
' Author: System Documentation
' Version: 1.0 (PlantUML)
' Date: 27 Desember 2024
' ============================================================================

skinparam backgroundColor #FEFEFE
skinparam shadowing false
skinparam defaultFontName "Segoe UI"
skinparam defaultFontSize 10

skinparam sequence {
    ArrowColor #455A64
    ArrowFontColor #37474F
    LifeLineBorderColor #78909C
    LifeLineBackgroundColor #ECEFF1
    ParticipantBorderColor #37474F
    ParticipantBackgroundColor #FFFFFF
    ActorBorderColor #1976D2
    ActorBackgroundColor #E3F2FD
    BoxBorderColor #9E9E9E
    BoxBackgroundColor #FAFAFA
}

autonumber

title **SD-04: Proses Pembinaan Internal Siswa**

actor "Pembina\n(WK/Kaprodi/Waka)" as PEMBINA

box "Application Layer" #E8F5E9
    participant "PembinaanController" as PC
    participant "PembinaanService" as PS
    participant "NotificationService" as NS
end box

box "Data Layer" #FFF3E0
    participant "PembinaanStatus" as PBS
    participant "PembinaanInternalRule" as PIR
    database "MySQL" as DB
end box

== Trigger Pembinaan (dari Rules Engine) ==

note over PIR, DB
  Pembinaan di-trigger otomatis
  saat total poin siswa masuk range rule
end note

PIR -> PBS : create(siswa_id, rule_id, poin)
PBS -> DB : INSERT INTO pembinaan_status\n(status = 'PERLU_PEMBINAAN')
DB --> PBS : Created

PBS -> NS : notifyPembina(pembinaan)
NS --> PEMBINA : Email/Push Notification

== Pembina Melihat Daftar Siswa ==

PEMBINA -> PC : GET /pembinaan/perlu-pembinaan
activate PC

PC -> PS : getSiswaPerluPembinaan(userId)
activate PS

PS -> PBS : whereStatus('PERLU_PEMBINAAN')\n->filterByRole(user)
PBS -> DB : SELECT * FROM pembinaan_status\nWHERE status = 'PERLU_PEMBINAAN'
DB --> PBS : List<PembinaanStatus>
PBS --> PS : Collection

PS --> PC : paginated list
deactivate PS

PC --> PEMBINA : Tampilkan daftar siswa
deactivate PC

== Mulai Pembinaan ==

PEMBINA -> PC : POST /pembinaan/{id}/mulai
activate PC

PC -> PS : mulaiPembinaan(id, userId)
activate PS

PS -> PBS : find(id)
PBS -> DB : SELECT * FROM pembinaan_status
DB --> PBS : PembinaanStatus record

PS -> PBS : update([status, dibina_oleh, dibina_at])
PBS -> DB : UPDATE pembinaan_status\nSET status = 'SEDANG_DIBINA',\ndibina_oleh_user_id = ?,\ndibina_at = NOW()
DB --> PBS : Updated

PS --> PC : Success
deactivate PS

PC --> PEMBINA : Flash "Pembinaan dimulai"
deactivate PC

== Proses Pembinaan Berlangsung ==

note over PEMBINA
  Pembina melakukan:
  - Dialog dengan siswa
  - Input catatan pembinaan
  - Identifikasi masalah
end note

PEMBINA -> PC : PUT /pembinaan/{id}/catatan
PC -> PS : updateCatatan(id, catatan)
PS -> PBS : update(['catatan_pembinaan'])
PBS -> DB : UPDATE catatan_pembinaan
DB --> PBS : Updated
PBS --> PS : Success
PS --> PC : Success
PC --> PEMBINA : Catatan tersimpan

== Selesaikan Pembinaan ==

PEMBINA -> PC : POST /pembinaan/{id}/selesai\n(hasil_pembinaan)
activate PC

PC -> PS : selesaikanPembinaan(id, userId, hasil)
activate PS

PS -> PBS : find(id)
PS -> PBS : update([status, selesai_by, selesai_at, hasil])
PBS -> DB : UPDATE pembinaan_status\nSET status = 'SELESAI',\ndiselesaikan_oleh_user_id = ?,\nselesai_at = NOW(),\nhasil_pembinaan = ?
DB --> PBS : Updated

PS --> PC : Success
deactivate PS

PC --> PEMBINA : Flash "Pembinaan selesai"
deactivate PC

note right of PEMBINA #C8E6C9
  Pembinaan SELESAI
  Status = FINAL
end note

@enduml
